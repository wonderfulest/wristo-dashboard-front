# Wristo é‚®ä»¶æ¨¡æ¿ç®¡ç†ç³»ç»Ÿï¼ˆæ··åˆæ¨¡å¼ç®€åŒ–ç‰ˆï¼‰PRD


ğŸ¯ ä¸€ã€é¡¹ç›®èƒŒæ™¯

å½“å‰ Wristo é‚®ä»¶æ¨¡æ¿å‡ä¸ºé™æ€æ–‡ä»¶ (resources/templates/*.html)ï¼Œä¿®æ”¹éœ€é€šè¿‡ Git æäº¤ + é‡å¯éƒ¨ç½²ï¼Œæµç¨‹å†—é•¿ã€‚
è¿è¥äººå‘˜æ— æ³•å¿«é€Ÿè°ƒæ•´é‚®ä»¶å†…å®¹ï¼Œå¦‚ï¼š

è¥é”€æ´»åŠ¨ã€èŠ‚æ—¥ç¥ç¦é‚®ä»¶ï¼›

æ”¯ä»˜æˆåŠŸã€æ³¨å†Œã€é‡ç½®å¯†ç ç±»ç³»ç»Ÿé€šçŸ¥ï¼›

äº§å“æ›´æ–°é€šçŸ¥æˆ–è®¢é˜…æé†’ã€‚

å› æ­¤éœ€æ„å»ºä¸€ä¸ª â€œå¯è¿è¥åŒ–çš„æ¨¡æ¿ç®¡ç†ç³»ç»Ÿâ€ï¼Œæ”¯æŒï¼š

åœ¨çº¿å¯ç¼–è¾‘ï¼›

æ•°æ®åº“å­˜å‚¨ï¼›

åŠ¨æ€åŠ è½½ï¼›

æµ‹è¯•å‘é€ï¼›

åŒæ­¥æ›´æ–° HTML æ¨¡æ¿æ–‡ä»¶ã€‚

ğŸ§  äºŒã€è®¾è®¡åŸåˆ™
ç›®æ ‡	è¯´æ˜
âš¡ å¿«é€Ÿé…ç½®	è¿è¥å¯ç›´æ¥ä¿®æ”¹æ¨¡æ¿ï¼Œæ— éœ€å¼€å‘å‚ä¸
ğŸ§© æ··åˆæ¨¡å¼	æ¨¡æ¿å†…å®¹å­˜å‚¨äºæ•°æ®åº“ï¼ŒåŒæ—¶ä¿ç•™æ–‡ä»¶å¤‡ä»½
ğŸ”„ çƒ­åŠ è½½	æ›´æ–°åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
ğŸ§ª æµ‹è¯•éªŒè¯	æ”¯æŒæ¨¡æ¿å˜é‡é¢„è§ˆä¸æµ‹è¯•é‚®ä»¶å‘é€
ğŸ”’ å®‰å…¨å®¡è®¡	é™å®šç¼–è¾‘æƒé™ + æ“ä½œæ—¥å¿—

âŒ ä¸å†æ”¯æŒå†å²ç‰ˆæœ¬å›æ»šï¼Œä»…è®°å½•æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´ä¸ç¼–è¾‘äººã€‚

ğŸ— ä¸‰ã€ç³»ç»Ÿæ¶æ„æ¦‚è¿°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Wristo Admin åå°       â”‚
â”‚  â”œâ”€ æ¨¡æ¿åˆ—è¡¨ï¼ˆæœç´¢+ç­›é€‰ï¼‰       â”‚
â”‚  â”œâ”€ æ¨¡æ¿é¢„è§ˆï¼ˆHTML æ¸²æŸ“ï¼‰       â”‚
â”‚  â”œâ”€ åœ¨çº¿ç¼–è¾‘ï¼ˆå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼‰     â”‚
â”‚  â”œâ”€ æµ‹è¯•å‘é€ï¼ˆè¿è¥éªŒè¯ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Wristo API æœåŠ¡         â”‚
â”‚  â”œâ”€ TemplateController         â”‚
â”‚  â”œâ”€ TemplateService            â”‚
â”‚  â””â”€ HybridTemplateLoader       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     email_template è¡¨ (DB)     â”‚
â”‚     resources/templates/*.html â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ—ƒ å››ã€æ•°æ®åº“è¡¨ç»“æ„

æ²¿ç”¨ç°æœ‰ email_template è¡¨ï¼Œç•¥å¾®æ‰©å±•ä¸¤ä¸ªå­—æ®µï¼š

ALTER TABLE email_template 
ADD COLUMN content_html MEDIUMTEXT NULL COMMENT 'æ¨¡æ¿HTMLå†…å®¹',
ADD COLUMN last_editor VARCHAR(100) NULL COMMENT 'æœ€åç¼–è¾‘äºº';


æ–‡ä»¶ä»ä¿å­˜åœ¨ src/main/resources/templates/ï¼Œæ•°æ®åº“ä¿å­˜å…¶åœ¨çº¿ç¼–è¾‘ç‰ˆæœ¬ã€‚

âš™ï¸ äº”ã€æ¨¡æ¿åŠ è½½æœºåˆ¶ï¼ˆHybrid æ¨¡å¼ï¼‰

åŠ è½½ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š

1ï¸âƒ£ è‹¥æ•°æ®åº“ä¸­å­˜åœ¨ content_html ä¸” is_active=1 â†’ ä½¿ç”¨æ•°æ®åº“å†…å®¹
2ï¸âƒ£ å¦åˆ™ â†’ è¯»å– resources/templates/${template_file_name} æ–‡ä»¶
3ï¸âƒ£ æ¨¡æ¿å¼•æ“ä½¿ç”¨ StringTemplateResolver åŠ¨æ€æ¸²æŸ“ HTML å†…å®¹

ç¤ºä¾‹ä»£ç ï¼š

public String loadTemplate(String name) {
    EmailTemplate tpl = templateRepo.findByFileName(name);
    if (tpl != null && tpl.isActive() && tpl.getContentHtml() != null) {
        return tpl.getContentHtml();
    } else {
        return Files.readString(Paths.get("src/main/resources/templates/" + name));
    }
}

ğŸ§© å…­ã€ä¸»è¦åŠŸèƒ½æ¨¡å—
1ï¸âƒ£ æ¨¡æ¿åˆ—è¡¨é¡µ

åŠŸèƒ½ï¼šæŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿åŸºç¡€ä¿¡æ¯

å­—æ®µï¼š

å­—æ®µ	å«ä¹‰
æ¨¡æ¿åç§°	name
æ–‡ä»¶å	template_file_name
é‚®ä»¶ä¸»é¢˜	subject
æ˜¯å¦æ¿€æ´»	is_active
æ›´æ–°æ—¶é—´	updated_at
ç¼–è¾‘äºº	last_editor

æ“ä½œï¼š

é¢„è§ˆæ¨¡æ¿

ç¼–è¾‘æ¨¡æ¿

æµ‹è¯•å‘é€

2ï¸âƒ£ æ¨¡æ¿é¢„è§ˆé¡µ

åŠŸèƒ½ï¼š

æ¸²æŸ“ content_html å†…å®¹ï¼›

æ”¯æŒæ›¿æ¢å˜é‡å±•ç¤ºï¼ˆå¦‚ ${userName} â†’ â€œæµ‹è¯•ç”¨æˆ·â€ï¼‰ã€‚

å®ç°æ–¹å¼ï¼š
é€šè¿‡ th:utext="${content}" æ¸²æŸ“ HTML é¢„è§ˆã€‚

3ï¸âƒ£ æ¨¡æ¿ç¼–è¾‘é¡µ

åŠŸèƒ½ï¼š

åœ¨çº¿ç¼–è¾‘æ¨¡æ¿ HTMLï¼›

å¯æŸ¥çœ‹æ¨¡æ¿å˜é‡ï¼ˆå¦‚ ${orderId}, ${userName}ï¼‰ï¼›

ä¿å­˜åç«‹å³ç”Ÿæ•ˆã€‚

å®ç°æµç¨‹ï¼š

ç‚¹å‡»ä¿å­˜ â†’
æ›´æ–°æ•°æ®åº“ content_html â†’
å†™å…¥æ–‡ä»¶ç³»ç»Ÿ â†’
åˆ·æ–°ç¼“å­˜ï¼ˆHybridTemplateLoaderï¼‰ â†’
è¿è¥åå°æç¤ºâ€œæ¨¡æ¿æ›´æ–°æˆåŠŸâ€


Service é€»è¾‘ç¤ºä¾‹ï¼š

@Transactional
public void updateTemplate(Integer id, String html, String editor) {
    EmailTemplate tpl = repo.findById(id).orElseThrow();
    tpl.setContentHtml(html);
    tpl.setLastEditor(editor);
    tpl.setUpdatedAt(LocalDateTime.now());
    repo.save(tpl);

    Path path = Paths.get("src/main/resources/templates/", tpl.getTemplateFileName());
    Files.writeString(path, html, StandardCharsets.UTF_8);
}

4ï¸âƒ£ æµ‹è¯•å‘é€

åŠŸèƒ½ï¼š

è¾“å…¥ç›®æ ‡é‚®ç®±ï¼›

æ¸²æŸ“æ¨¡æ¿å¹¶å‘é€é‚®ä»¶ï¼›

ç”¨äºéªŒè¯æ¨¡æ¿å†…å®¹åŠå˜é‡æ­£ç¡®æ€§ã€‚

ç¤ºä¾‹æ¥å£ï¼š

@PostMapping("/admin/email-templates/{id}/test-send")
public ResponseEntity<?> testSend(@PathVariable Integer id, @RequestParam String toEmail) {
    emailTemplateService.testSend(id, toEmail);
    return ResponseEntity.ok("æµ‹è¯•é‚®ä»¶å·²å‘é€");
}


å‘é€é€»è¾‘ï¼š

æ¸²æŸ“æ¨¡æ¿ï¼›

æ›¿æ¢éƒ¨åˆ†å˜é‡ä¸ºé»˜è®¤å€¼ï¼›

è°ƒç”¨ JavaMailSender æˆ– AWS SESï¼›

è®°å½•æ—¥å¿—ã€‚

ğŸ§¾ ä¸ƒã€æ¥å£å®šä¹‰ï¼ˆåç«¯ APIï¼‰
æ¥å£	æ–¹æ³•	æè¿°
/admin/email-templates	GET	æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨
/admin/email-templates/{id}	GET	æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
/admin/email-templates/{id}/preview	GET	é¢„è§ˆæ¨¡æ¿HTML
/admin/email-templates/{id}/update	POST	ä¿å­˜ç¼–è¾‘å†…å®¹
/admin/email-templates/{id}/test-send	POST	æµ‹è¯•å‘é€é‚®ä»¶
ğŸ”’ å…«ã€æƒé™ä¸å®‰å…¨æ§åˆ¶
æ“ä½œ	è§’è‰²æƒé™	è¯´æ˜
æŸ¥çœ‹æ¨¡æ¿	ROLE_OPERATOR	ä»…å¯è¯»
ç¼–è¾‘æ¨¡æ¿	ROLE_ADMIN	å¯ä¿®æ”¹HTMLå†…å®¹
æ¿€æ´»/åœç”¨æ¨¡æ¿	ROLE_ADMIN	æ§åˆ¶ç”Ÿæ•ˆçŠ¶æ€
æµ‹è¯•å‘é€	ROLE_OPERATOR+	å…è®¸å‘é€é‚®ä»¶éªŒè¯

å®‰å…¨æªæ–½ï¼š

æ‰€æœ‰ä¿®æ”¹æ“ä½œéœ€è®°å½• last_editor ä¸ updated_atï¼›

ç¼–è¾‘å™¨å†…å®¹ä¿å­˜å‰è¿›è¡Œ XSS è¿‡æ»¤ï¼›

æ¯æ¬¡ä¿å­˜å‰è¿›è¡Œå˜é‡å ä½ç¬¦æ£€æµ‹ï¼Œé˜²æ­¢ç ´åæ¨¡æ¿ç»“æ„ã€‚

ğŸ§© ä¹ã€æ¨¡æ¿å¼•æ“é…ç½®ï¼ˆSpring Bootï¼‰

é…ç½®åŒæ¨¡æ¿è§£æå™¨ï¼š

@Bean
public TemplateEngine templateEngine() {
    TemplateEngine engine = new TemplateEngine();

    // 1. æ•°æ®åº“æ¨¡æ¿è§£æå™¨
    StringTemplateResolver dbResolver = new StringTemplateResolver();
    dbResolver.setTemplateMode(TemplateMode.HTML);
    dbResolver.setCacheable(false);
    dbResolver.setOrder(1);

    // 2. æ–‡ä»¶æ¨¡æ¿è§£æå™¨
    ClassLoaderTemplateResolver fileResolver = new ClassLoaderTemplateResolver();
    fileResolver.setPrefix("templates/");
    fileResolver.setSuffix(".html");
    fileResolver.setTemplateMode(TemplateMode.HTML);
    fileResolver.setOrder(2);

    engine.setTemplateResolvers(Set.of(dbResolver, fileResolver));
    return engine;
}

ğŸ§± åã€é¡¹ç›®é˜¶æ®µè§„åˆ’
é˜¶æ®µ	åŠŸèƒ½èŒƒå›´	é¢„è®¡å®Œæˆæ—¶é—´
V1.0	æ¨¡æ¿ç®¡ç†åå°åˆ—è¡¨ + é¢„è§ˆ	2025-10
V1.1	åœ¨çº¿ç¼–è¾‘ + æ–‡ä»¶åŒæ­¥ + æµ‹è¯•å‘é€	2025-11
V1.2	æ¨¡æ¿å˜é‡æ ¡éªŒ + å¤šè¯­è¨€æ”¯æŒ	2025-12
ğŸ“ˆ åä¸€ã€é¡¹ç›®ä»·å€¼
ç»´åº¦	æå‡
è¿è¥æ•ˆç‡	æ¨¡æ¿è°ƒæ•´æ—¶é—´ä» 1 å¤© â†“ è‡³ 10 åˆ†é’Ÿ
æŠ€æœ¯ç»´æŠ¤	æ— éœ€é‡æ–°éƒ¨ç½²å³å¯çƒ­æ›´æ–°æ¨¡æ¿
å‡ºé”™ç‡	é™ä½ 80%ï¼Œå¯å³æ—¶é¢„è§ˆéªŒè¯
å›¢é˜Ÿåä½œ	è¿è¥ã€å¼€å‘ã€è®¾è®¡å¯ååŒç»´æŠ¤